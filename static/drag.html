<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>jQuery UI Dragging</title>
    <link href="/static/styles.css" rel="stylesheet">

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js" type="text/javascript"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.9.2/jquery-ui.min.js"></script>
    <script src="/static/jquery.json-2.4.min.js"></script>

    <script type="text/javascript">
        $(document).ready(function() {

            $('.logos').draggable({
                cursor: 'move',
                opacity: 0.35,
                containment: '#par',
                stack: $('.logos'),

                stop: function(event, ui) {
                    var offset = $(this).offset();
                    var xPos = offset.left;
                    var yPos = offset.top;
                    console.log('x: ' + xPos);
                    console.log('y: ' + yPos);
                }
            });

            var board_left =    $('#board').offset().left;
            var board_top = $('#board').offset().top;

            $('.save_button').click(function(){
                var data = [];
                var c_ids = [];

                $('.logos').each(function() {
                    //if (($(this).offset().left - board_left) < $('#board').width()) {
                        var x = ($(this).offset().left - board_left)
                        var y = ($(this).offset().top - board_top)
                        var _id = String($(this).attr('my_id'));

                        if (_id) {
                            data.push( { "x": x, "y": y, "c": _id } );
                            c_ids.push( {"c": _id });
                        }
                    // } else {
                    //     console.log('not on board')
                    // }
                });

                $.ajax ({
                    type: "POST",
                    url: '/data/',
                    dataType: 'json',
                    contentType: "application/json; charset=utf-8",
                    // ' & " Quotes MUST be this way round
                    //data: '[{"x":"104", "y":"330"}, {"x":"104", "y":"330"}]',
                    data:    $.toJSON(data),
                }).done(function(result) {

                    $.ajax ({
                        type: "POST",
                        url: '/averages/',
                        dataType: 'json',
                        contentType: "application/json; charset=utf-8",
                        data:    $.toJSON(c_ids),
                    }).done(function(result2) {
                        display_averages( result2 );
                    });

                });

            });

            function display_averages(data) {
                results = data['result'];
                ids = [];

                for (var i = 0; i < results.length; i++) {
                    ids.push(results[i]['_id']);
                }

                $('.logos').each(function() {
                    var my_id = String($(this).attr('my_id'));

                    if ($.inArray(my_id, ids) != -1) {
                        $("#average_1").show();
                        $("#average_1").offset({top:300, left:5});

                        // var average_of_this = $(this).clone();

                        // average_of_this.contents().filter(function(){
                        //     return this.nodeType == 3;
                        // }).last().replaceWith("Average");

                        // average_of_this.css('postiion', 'relative');

                        // average_of_this.offset({top:30, left:0});
                        // average_of_this.appendTo($('#par'));

                        // average_of_this.draggable({
                        //     cursor: 'move',
                        //     opacity: 0.35,
                        //     containment: '#par',
                        //     stack: $('.logos'),

                        //         $(this).offset().left = 300;
                        //         $(this).offset().top = 300;
                        //     stop: function(event, ui) {
                        //         var offset = $(this).offset();
                        //         var xPos = offset.left;
                        //         var yPos = offset.top;
                        //         console.log('x: ' + xPos);
                        //         console.log('y: ' + yPos);
                        //     }
                        // });

                    }
                });
            }
        });

    </script>
</head>

<body>
    <h4>Click and drag:</h4>
    <h4>more headings</h4>
    <h4>more headings</h4>
    <h4>more headings</h4>
    <form action='/data/' method='post'>
        <input name='a' value='2' />
        <input name='b' value='4' />
        <input type='submit' />
    </form>

    <div id='par' style='background-color:#AAA; width:600px; height:400px'>
        <div id='board' style='background-color:#099; width:400px; height:400px; float:left;'></div>

        <span class='logos' my_id='1' >
            <img src='/static/img/dropbox-logo.jpg'/>
            Dropbox
        </span>

        <span class='logos' style='display:none' id='average_1'>
            <img src='/static/img/dropbox-logo.jpg'/>
            Average
        </span>

        <span class='logos' my_id='2'>
            <img src='/static/img/facebook-logo.jpg'/>
            Facebook
        </span>

        <span class='logos' style='display:none' id='average_2'>
            <img src='/static/img/facebook-logo.jpg'/>
            Average
        </span>

    </div>
    <button class='save_button' >save</button>

</body>
</html>
