<!DOCTYPE HTML>
<html>
<head>
    <script src="kinetic.min.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js" type="text/javascript"></script>
    <script src="/static/jquery.json-2.4.min.js"></script>
    <link rel="stylesheet" href="styles.css" />
</head>

<body>
    <div id="text_chart">

        <p> Drag to position on to chart </p>

    </div>
   <div id="container"></div>

    <div id="table_image">
     <img src="img/table.png" alt="table"/>
    </div>
   
    <button class='save_button'>submit</button>

    <script>
        var total_width = 600;
        var total_height = 500;
        var grid_width = 500;

        $(document).ready(function() {

            $('.save_button').click(function(){
                var data = [];
                var c_ids = [];

                for (var i = 0; i < companies.length; i++) {
                    if (companies[i].getX() < grid_width) {
                        data.push( { "x": companies[i].getX(), "y": companies[i].getY(), "c": String(companies[i].getId()) } );
                        c_ids.push(String(companies[i].getId()));
                    }
                }

                // Save these positions
                $.ajax ({
                    type: "POST",
                    url: '/data/',
                    dataType: 'json',
                    contentType: "application/json; charset=utf-8",
                    data: $.toJSON(data),
                }).done(function(result) {

                    // Positions saved. Now load the averages
                    $.ajax ({
                        type: "POST",
                        url: '/averages/',
                        dataType: 'json',
                        contentType: "application/json; charset=utf-8",
                        data: $.toJSON(c_ids),
                    }).done(function(result2) {
                        display_averages( result2 );
                    });

                });
            });
            function display_averages(data) {
                var results = data['result'];
                average_layer.remove();
                average_layer = new Kinetic.Layer();

                for (var i = 0; i < results.length; i++) {
                    var c = null;
                    if (results[i]._id == 1) {
                         c = build_company_group(30, 'Facebook Avg.', 1, true, '#3B5998', 'bold');
                    } else if (results[i]._id == 2) {
                        c = build_company_group(60, 'Twitter Avg.', 2, true, '#4099FF', 'bold');
                    } else if (results [i]._id == 3) {
                        c = build_company_group(90,'Gmail Avg.', 3, true, '#dd1812', 'bold');
                    } else if (results [i]._id == 4) {
                        c = build_company_group(120, 'Dropbox Avg.', 4, true, '#3d4944', 'bold');
                    } else if (results [i]._id == 5) {
                        c = build_company_group(150, 'Amazon Avg.', 5, true, '#e47911', 'bold');
                    } else if (results [i]._id == 6) {
                        c = build_company_group(180, 'eBay Avg.', 6, true, '#ffcc00', 'bold');
                    } 

                    if (c != null) {
                        c.setX(results[i].avgx);
                        c.setY(results[i].avgy);
                        average_layer.add(c);
                    }
                }
                stage.add(average_layer);

            }
            var average_layer = new Kinetic.Layer();

        });

        var companies = [];
        var stage;
        var imgObj = new Image();

        function build_company_group(y, c_name, c_id, is_average, comp_color, bold) {
            var group = new Kinetic.Group({
                x: grid_width,
                y: y,
                draggable: !is_average,
                id: c_id,
            });
            

            var simpleText = new Kinetic.Text({
                x: 10,
                y: 30,
                text: c_name,
                fontSize: 12,
                fontFamily: 'Helvetica, Arial',
                fontStyle: bold,
                fill: comp_color
            });

            group.add(simpleText);

            group.on('mouseover', function() {
                document.body.style.cursor = 'pointer';
            });
            group.on('mouseout', function() {
                document.body.style.cursor = 'default';
            });
            return group;
        }

        function build_background(layer, stage_width, stage_height) {
            var grid_background = new Kinetic.Rect({
                x: 0,
                y: 100,
                width: total_width,
                height: total_height
            });
            
            layer.add(grid_background);
            
            var grid_background = new Kinetic.Rect({
                x: grid_width,
                y: 0,
                width: total_width - grid_width,
                height: total_height
            });

            layer.add(grid_background);
        }

        stage = new Kinetic.Stage({
            container: 'container',
            width: total_width,
            height: total_height,
        });
        var layer = new Kinetic.Layer();

        // yuck!
        build_background(layer, stage.getWidth(), stage.getHeight());


        var c = build_company_group(30, 'Facebook', 1, false, '#3B5998');
        companies.push(c);
        layer.add(c);

        var c = build_company_group(60, 'Twitter', 2, false, '#4099FF');
        companies.push(c);
        layer.add(c);

        var c = build_company_group(90, 'Gmail', 3, false, '#dd1812');
        companies.push(c);
        layer.add(c);

        var c = build_company_group(120, 'Dropbox', 4, false, '#3d4944');
        companies.push(c);
        layer.add(c);


        var c = build_company_group(150, 'Amazon', 5, false, '#e47911');
        companies.push(c);
        layer.add(c);

        var c = build_company_group(180, 'eBay', 6, false, '#ffcc00');
        companies.push(c);
        layer.add(c);

        stage.add(layer);
    </script>
 </body>
</html>
