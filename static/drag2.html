<!DOCTYPE HTML>
<html>
<head>
    <script src="kinetic.min.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js" type="text/javascript"></script>
    <script src="/static/jquery.json-2.4.min.js"></script>
    <link rel="stylesheet" href="styles.css" />
</head>

<body>
    <div id="text_chart"> Drag to position on to chart</div>

    <div id="chart">
      <div id="container"></div>
      <div id="userplacement"></div>
      <div id="averagecontainer"></div>
      <div id="nondraggable"></div>

    </div>

    <div id="table_image">
     <img src="img/table.png" alt="table"/>
     <img src ="img/table_trend.png" alt="trend" id="trend"/>
    </div>


    <div id="average_showhide">

        <div class="onoffswitch">
            <input type="checkbox" name="onoffswitch" class="onoffswitch-checkbox" id="myonoffswitch" checked>
            <label class="onoffswitch-label" for="myonoffswitch">
                <div class="onoffswitch-inner"></div>
                <div class="onoffswitch-switch"></div>
            </label>
        </div>
    </div>

    <div id="your_showhide">
        <div class="onoffswitch-user">
            <input type="checkbox" name="onoffswitch-user" class="onoffswitch-checkbox-user" id="onoffswitch-user" checked>
            <label class="onoffswitch-label-user" for="onoffswitch-user">
                <div class="onoffswitch-inner-user"></div>
                <div class="onoffswitch-switch-user"></div>
            </label>
        </div>

    </div>

    <button class='save_button'>Submit</button>

    <div id="email">
        <p>Enter your email address, and we'll send you <br/> a download link, when we've compiled all the data</p>
        <script type="text/javascript">
                var submitted = false;
        </script>

        <iframe name="hidden_iframe" id="hidden_iframe"

            style="display:none;" onload="if (submitted)
            {
                window.location = '#';
            }">

        </iframe>

        <form id="email_form" action="https://docs.google.com/spreadsheet/formResponse?formkey=dENQZXRIb0s1T2VEZDdCdzB4NlRtZ0E6MQ&amp;ifq" method="post"
                  target="hidden_iframe" onsubmit="submitted = true;">

            <div class="errorbox-good">
                <input type="text" name="entry.0.single" value="" class="required_mail email" id="entry_0" placeholder="Enter your email address">
                <input type="submit" name="submit" class="submit-button-sidebar " value="">

            </div>

                <input type="hidden" name="pageNumber" value="0">
                <input type="hidden" name="backupCache" value="">

        </form>
    </div>


    <script>
    var total_width = 600;
    var total_height = 500;
    var grid_width = 500;

    var companies = [];
    var stage;
    var stage_average;
    var stage_draggable;
    var stage_menu_on_right;
    var imgObj = new Image();
    var layer_nondraggable = new Kinetic.Layer();

    var company_options = {
        1: ['Facebook', '#3B5998'],
        2: ['Twitter', '#4099FF'],
        3: ['Gmail', '#dd1812'],
        4: ['Dropbox', '#3d4944'],
        5: ['Amazon', '#e47911'],
        6: ['eBay', '#ffcc00'],
    }

    $(document).ready(function() {

        $('.save_button').click(function(){
            var data = [];
            var c_ids = [];

            //Text Changes when the user clicks on submit
            document.getElementById("text_chart").innerHTML = "Mouseover to highlight";

            //Shows the trend lines when the user clicks on submit
            $('#trend').show();

            //Shows the toggle to display averages on the grid
            $('#average_showhide').show();

            $('#averagecontainer').show();
            //show email form field
            $('#email').show();

            //show non-draggable div after the user submits
            $('#nondraggable').show();

            $('#your_showhide').show();
            //Shows or Hides the Averages
            $( "#myonoffswitch" ).click(function() {
                $('#averagecontainer').toggle();
            });

            $("#onoffswitch-user").click(function(){
                $('#userplacement').toggle();
            });

            for (var i = 0; i < companies.length; i++) {
                if (companies[i].getX() < grid_width) {
                    data.push( { "x": companies[i].getX(), "y": companies[i].getY(), "c": String(companies[i].getId()) } );
                    c_ids.push(String(companies[i].getId()));
                }
            }

            // Save these positions
            $.ajax ({
                type: "POST",
                url: '/data/',
                dataType: 'json',
                contentType: "application/json; charset=utf-8",
                data: $.toJSON(data),
            }).done(function(result) {

                // Positions saved. Now load the averages
                $.ajax ({
                    type: "POST",
                    url: '/averages/',
                    dataType: 'json',
                    contentType: "application/json; charset=utf-8",
                    data: $.toJSON(c_ids),
                }).done(function(result2) {
                    display_averages( result2 );
                });

            });


        });

        function display_averages(data) {
            var results = data['result'];
            average_layer.remove();
            average_layer = new Kinetic.Layer();

            for (var i = 0; i < results.length; i++) {
                if (results[i]._id > 0 && results[i]._id < 7) {
                    var c = build_company_group_average(results[i]._id)
                    if (c != null) {
                        c.setX(results[i].avgx);
                        c.setY(results[i].avgy);
                        average_layer.add(c);
                    }
                }
            }
            stage_average.add(average_layer);

        }
        var average_layer = new Kinetic.Layer();

   //End of document ready
    });

    function build_company_group_draggable(c_id) {
        return _build_company_group(c_id * 30, company_options[c_id][0], c_id, true, company_options[c_id][1], 1, false, '');
    }

    function build_company_group_hoverable(c_id) {
        var group = _build_company_group(c_id * 30, company_options[c_id][0], c_id, false, company_options[c_id][1], 1, true, '');

        group.on('mouseover', function() {
            document.body.style.cursor = '';

            stage_menu_on_right.get('.company_logo_text').each(function(child, n) {
                child.setAttr('fill', '#CCC');
            });
            stage_menu_on_right.get('.company_logo_border').each(function(child, n) {
                child.setAttr('stroke', '#CCC');
            });
            stage_draggable.get('.company_logo_text').each(function(child, n) {
                child.setAttr('fill', '#CCC');
            });
            stage_draggable.get('.company_logo_border').each(function(child, n) {
                child.setAttr('stroke', '#CCC');
            });
            stage_average.get('.company_logo_text').each(function(child, n) {
                child.setAttr('fill', '#CCC');
            });
            stage_average.get('.company_logo_border').each(function(child, n) {
                child.setAttr('stroke', '#CCC');
            });

            group.get('.company_logo_text').each(function(child, n) {
                child.setAttr('fill', group.getAttr('real_color'));
            });
            group.get('.company_logo_border').each(function(child, n) {
                child.setAttr('stroke', group.getAttr('real_color'));
            });

            stage_menu_on_right.batchDraw();
            stage_draggable.batchDraw();
            stage_average.batchDraw();
        });

        return group;
    }

    function build_company_group_average(c_id) {
        return _build_company_group(0, company_options[c_id][0] + ' Avg', c_id, false, company_options[c_id][1], 3, false, 'bold');
    }

    function _build_company_group(y, c_name, c_id, draggable, comp_color,stroke_width, is_hoverable, bold) {
        var group = new Kinetic.Group({
            x: grid_width,
            y: y,
            draggable: draggable,
            id: c_id,
            real_color: comp_color,
        });

        var simpleText = new Kinetic.Text({
            x: 5,
            y: 30,
            text: c_name,
            fontSize: 12,
            fontFamily: 'Helvetica, Arial',
            fontStyle: bold,
            fill: comp_color,
            name: 'company_logo_text'
        });

        var border = new Kinetic.Rect({
            x: 0,
            y: 25,
            width: 95,
            height: 20,
            fill: "#fff",
            stroke: comp_color,
            strokeWidth: stroke_width,
            name: 'company_logo_border'
        });

        group.add(border);
        group.add(simpleText);

        group.on('mouseover', function() {
            document.body.style.cursor = 'pointer';
        });
        group.on('mouseout', function() {
            document.body.style.cursor = 'default';
        });
        return group;
    }

    // function build_background(layer, stage_width, stage_height) {
    //     var grid_background = new Kinetic.Rect({
    //         x: 0,
    //         y: 100,
    //         width: total_width,
    //         height: total_height
    //     });

    //     layer_background.add(grid_background);

    //     var grid_background = new Kinetic.Rect({
    //         x: grid_width,
    //         y: 0,
    //         width: total_width - grid_width,
    //         height: total_height
    //     });

    //     layer_background.add(grid_background);
    // }

    stage = new Kinetic.Stage({
        container: 'container',
        width: total_width,
        height: total_height,
    });

    stage_average = new Kinetic.Stage ({

        container: 'averagecontainer',
        width: 600,
        height: total_height,
    });

    stage_draggable = new Kinetic.Stage ({

        container: 'userplacement',
        width: 600,
        height: total_height,
    });

    stage_menu_on_right = new Kinetic.Stage ({

        container: 'nondraggable',
        width: 600,
        height: total_height,
    });

    var layer = new Kinetic.Layer();
    var layer_background = new Kinetic.Layer();

    // yuck!
    //build_background(layer, stage.getWidth(), stage.getHeight());

    for(var row in company_options) {
        var c = build_company_group_draggable(row);
        companies.push(c);
        layer.add(c)

        var c = build_company_group_hoverable(row);
        layer_nondraggable.add(c);
    }

    stage.add(layer_background);
    stage_draggable.add(layer);
    stage_menu_on_right.add(layer_nondraggable);


    </script>
 </body>
</html>
